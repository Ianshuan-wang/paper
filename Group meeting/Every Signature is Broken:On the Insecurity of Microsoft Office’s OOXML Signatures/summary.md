# Abstract

办公文档的结构与数字签名的验证方式之间存在重大差异

# 1 Introduction

**呈现流与签名验证流**

签名证实了源自签名者的信息并没有改变

1. 内容注入攻击 (CIA) 滥用标准的差异将呈现的内容放置在应该用于不同目的的文件中，例如持有元信息。
2. 内容掩蔽攻击 (CMA) 以这样一种方式签名文档后操纵样式或字体信息，显示不同的内容。
3. 遗留包装器攻击 (LWA) 将遗留文档（例如 *.doc）的签名嵌入到 OOXML 文档中。

### Implementation Flaws

USF 通用签名伪造

MRA 恶意修复攻击

- 渲染流程
    - 签名后添加的内容还能不能被渲染
- 签名验证流程
    - 有种部分签名的结构 可以被操作

## 贡献

1. 系统分析OOXML 系统地提取和分析了渲染和签名验证
2. 确定了三个问题
    1. OOXML使用部分签名
    2. 签名与未签名内容之间的渲染无差异
    3. 数字签名加密验证很复杂
3. 攻击：受害者打开文档检查不出篡改
4. 评估不同系统的office
5. 提出解决方法

# 2 The OOXML Document Format

## Document Structure

_rels/.rels

关系文件

word/document.xml 

文档打开后 存放文档内容

word/_rels/document.xml.rels 关系文件定义了一个包含所有进一步文件的目录。因此，应用程序知道包含哪些文件以及在哪里查找它们

## Rendering Process

word/document.xml 作为基础 包含其他引用文件

## Digital Signature

Package Info

通过引用它们的名称和路径列出所有受保护的文件

保护 document.xml.rels document.xml fontTable.xml styles.xml等

Office Info

存储程序偏好 例office版本

Signature Properties

定义了关于签名生成的元数据，如时间戳和使用证书。

Signed Info

引用Package Info、Office Info 和Signature Properties。

Signature Value

存储在Signed Info上计算的数字签名

Key Info

指用于对文档进行签名的键。该区域没有签名，以便攻击者可以操纵它。

## Verification Flow

1. 验证过程从签名值开始 确保Package Info Office Info Signature Properties没有被修改
2. 计算每个参考的摘要值，并将它们与存储的摘要值进行比较 成功的验证意味着所有三个区域都没有修改
3. 验证密钥信息持有的证书可信度

## UI Layer

UI 层：反映文档的签名状态

1. 签名有效 可信
    1. 完整签名
    2. 部分签名
2. 签名有效 不可信
3. 无效

## chat

### **文档结构（Document Structure）**

- **OOXML文档**是基于ZIP压缩的包，包含多个文件和目录，这些构成了文档的内容和结构。
- 核心文件如**`[Content_Types].xml`**定义了包含在OOXML包中的文件类型及其路径。
- 关系文件（位于**`_rels/.rels`**目录下）定义了主要文档文件（如**`word/document.xml`**）和其他属性文件（如作者信息等）之间的关系。
- 文档的主要内容存储在**`word/document.xml`**中，而**`word/_rels/document.xml.rels`**则定义了其他需要渲染的文件，如样式、主题等。

### **渲染过程（Rendering Process）**

- OOXML文档的渲染开始于**`word/document.xml`**文件，包含XML标记定义的文本内容。
- 文档渲染时会引用其他文件，如样式定义（**`word/styles.xml`**）、字体表（**`word/fontTable.xml`**）等，这些引用通过关系文件指定。

### **数字签名（Digital Signature）**

- OOXML文档支持使用XML签名技术来保证文档内容的完整性和来源的真实性。
- 每个签名存储在一个独立的XML文件中，包括签名本身（Signature Value）、签名信息（如签名时间和签名者信息）以及对文档各部分的引用和散列值，以验证内容的未被修改。

### **验证流程（Verification Flow）**

- 签名验证从Signature Value开始，验证签名是否由信任的实体生成，接着比较文档当前的散列值与签名文件中记录的散列值是否一致，以此确认文档自签名后是否被篡改。
- 签名验证还包括检查签名所用的证书是否可信，常见于使用Windows证书存储进行PKI验证。

### **UI层（UI Layer）**

- Microsoft Office等软件通过UI层展示文档的签名状态，包括签名有效、签名存在问题或签名无效等。
- 签名状态通过一系列的UI提示展示，包括顶部的安全警告条和详细的签名信息对话框，以便用户了解文档的安全性。

# 3 Attacker Model

## Attacker Capabilities

攻击者可以访问可信签名的文档

攻击者可以完全或部分选择要签名的文档内容。受害者信任该文档签名

## Attacker Goal: Data Manipulation

由于签名保护文档的完整性，理想的攻击目标是在不验证签名状态的情况下更改文档内容

如果签名显示为有效和可信，则攻击成功，恶意内容渲染给受害者

## Victim's Behaviour

希望受害者打开受信任的签名文档 排除不受信任的签名

## chat

### **攻击者能力（Attacker Capabilities）**

攻击者模型定义了两种主要的能力，这些能力描述了攻击者在进行攻击时所能利用的资源和条件：

1. **信任的签名文档（Trustfully Signed Document）**：攻击者可以获得一个由可信实体信任签名的文档。这样的文档可能是公开可获取的，例如，一个官方发布的、已签名的文件。
2. **签名预言机（Signing Oracle）**：在这种模型中，攻击者可以利用一个“签名预言机”，即可以请求签名实体对特定内容进行签名的能力。这种情况下，攻击者可以控制要被签名的文档的部分或全部内容，但需确保恶意载荷在签名过程中不被发现或执行。

### **攻击者目标：数据操纵（Attacker Goal: Data Manipulation）**

攻击者的主要目标是数据操纵，即通过修改已签名文档的内容，达到欺骗受害者的目的，而不会使数字签名失效。成功的攻击将允许攻击者在保持签名有效的情况下，改变文档的显示内容，使得受害者看到的内容与原始签名内容不同。

### **受害者行为（Victim's Behaviour）**

攻击者模型还考虑了受害者的预期行为：

- 受害者期望打开一个由可信权威签名的文档，并相信该文档的内容是真实和未被篡改的。
- 受害者不会信任带有无效或不可信签名的文档。因此，攻击的成功部分依赖于攻击者能否在不破坏签名有效性的前提下修改文档内容。
- 本模型假设受害者对文档的来源和签名状态有一定程度的意识，因此，攻击者需精心设计攻击以避免引起受害者的怀疑。

# 4 Systematic Analysis

## Phase 1: Security Issues in the OOXML Standard.

OOXML 标准不保护整个OOXML包的部分签名使用部分签名来保护整个 OOXML 包                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

此功能允许攻击者在签名后包含对随后添加的文件的引用

OOXML 中数字签名的创建和验证至少与完全完整性保护的安全目标相矛盾。

## Phase 2: OOXML Signatures in Microsoft Office

通过阶段 1 和 2 中的分析，可以识别三种可能的攻击点：（1）对现有无符号文件的操作，（2）签名文件的操作（3）后来添加的文件或引用进行操作。

## Phase 3: Manipulation of Unsigned Files

插入属性文件中的样式元素或内容实际上并未显示为带有攻击向量的文档内容。

只有文档的 创建者、相关时间戳 被修改不会使签名无效

创建了 24 个具有不同攻击向量的 OOXML

## Phase 4: Manipulation of the Signature File

如果缺少对打包信息的引用，则 OOXML 包的渲染内容不受签名的保护。

对于签名排除、证书伪造、节点分裂、HMAC截断等攻击 可以在签名的OOXML文档中找到漏洞

## Phase 5: Manipulation Based on Partial Signatures

是否存在通过打开文档呈现 但没有在document.xml中引用的文件

是否可以将document.xml引用的文件从签名计算中排除

一次性攻击：

大多数攻击利用了OOXML对部分签名的支持 部分签名无法保护文档

## Attack Vector Generation

## chat

### **五个阶段的分析**

1. **安全问题在OOXML标准中的分析**：
    - 分析OOXML标准，发现使用部分签名而不保护整个OOXML包是主要的安全问题源头。
    - 识别到，关系文件（如**`.rels`**文件）只进行了部分签名，允许攻击者在不破坏签名的情况下添加新的文件引用。
2. **OOXML签名在Microsoft Office中的实践分析**：
    - 研究Microsoft Office如何创建和签名OOXML文档，确认了Office支持部分签名的做法。
    - 发现一些文件（如**`[Content_Types].xml`**）在签名过程中未被完全保护。
3. **对未签名文件的操纵分析**：
    - 通过修改未签名的文件，尝试影响文档内容或样式，大部分尝试未能成功改变文档的渲染内容。
    - 证实了对某些文件的修改可以在不影响签名的情况下改变文档的元数据。
4. **对签名文件的操纵分析**：
    - 分析签名文件的结构，尝试通过修改签名文件来绕过签名验证。
    - 识别出，缺少对签名文件中某些关键元素（如Package Info的引用）的验证是可被利用的漏洞。
5. **基于部分签名的操纵分析**：
    - 深入研究OOXML文档中的部分签名机制，探索通过添加或修改文件来影响文档内容的可能性。
    - 成功构造了多种攻击方式，包括内容注入攻击和利用文档修复功能的攻击。

### **攻击向量的生成**

- 研究者通过系统性地分析OOXML标准和Microsoft Office的实现，识别出可利用的安全漏洞，并基于这些漏洞设计攻击方法。
- 攻击向量的生成依据对文档结构的理解，涉及对OOXML包内文件的添加、修改和引用变更，以满足攻击的需求。
- 创建了超过430种不同的攻击向量，这些向量通过不同方式操纵文档结构和签名文件，旨在绕过签名验证而不触发警报。
- 攻击向量的生成考虑了不同的操纵技术，包括但不限于修改未签名内容、篡改签名文件以及利用文档修复功能进行恶意内容替换。

# 5 Specification Attacks on OOXML

## 5.1 内容注入攻击

### 操作技术

利用OOXML规范中允许添加和引用未签名文件的缺陷 document.xml.rels的部分签名覆盖

### 步骤

1. 一个可信签名的OOXML文档
2. people.xml
    1. 攻击内容
    2. 添加到OOXML包的word子文件中
3. Content_Types.xml引用people.xml
4. 引用恶意文件people.xml操作document.xml.rels 因为关系文件只有部分签名 已签名的元素不能被篡改 但是可以添加新的文件而不会使签名无效

## 5.2 内容屏蔽攻击

删除document.xml.rels中对fontTable.xml或style.xml的引用

引用攻击者自己的

### 步骤

1. **签名过程**：在内容屏蔽攻击中，攻击者首先需要一个由签名实体签名的文档。这可以通过直接从签名实体获取一个签名的文档，或者通过一个签名预言机（Signing Oracle）获取，后者指攻击者可以控制部分内容让签名实体签名。
2. **准备修改**：一旦拥有了签名的文档，攻击者便开始准备修改。对于字体注入攻击（Font Injection Attack，FIA），攻击者创建或修改字体文件，使其在显示时隐藏或替换特定字符。对于样式注入攻击（Style Injection Attack，SIA），攻击者则准备修改文档的样式定义。
3. **移除引用**：在文档签名之前，攻击者确保文档不引用他们打算修改的样式或字体文件。这样，这些文件就不会被包含在签名的范围内。
4. **签名**：文档被签名实体签名。由于攻击者准备修改的文件没有被引用，它们不会被签名，因此攻击者可以在不破坏签名的情况下修改它们。
5. **修改**：文档被签名后，攻击者将他们修改过的样式或字体文件添加到文档中，并确保文档引用这些新添加或修改的文件。
6. **分发**：最后，攻击者将这个修改过并重新打包的文档分发给目标受害者。当受害者打开文档时，由于签名验证仅对签名时引用的内容进行，新增的修改不会触发签名验证失败。因此，受害者会看到被修改样式或字体影响后的内容，而不是原始签名内容。

## 5.3 遗留包装攻击

使用旧二进制文件格式（.doc）的word文档签名

### 步骤

- chat
    
    新文档的内容完全由攻击者控制。攻击者利用了旧版文档（如.doc格式）的签名，并在此基础上构造一个新的文档（如.docx格式），该新文档携带攻击者自定义的内容，同时伪装成由可信实体签名的文档：
    
    1. **获取签名的遗留文档**：攻击者首先需要获得一个由可信实体签名的遗留格式文档（如.doc）。这可以通过请求签名实体对无害内容进行签名来实现，或者找到一个已经存在的、由目标可信实体签名的文档。
    2. **创建新的OOXML文档**：接下来，攻击者创建一个新的OOXML格式文档（如.docx），这个文档包含了攻击者希望展示给受害者的内容。这一步完全在攻击者的控制之下，他们可以自由地决定文档中的内容和格式。
    3. **注入遗留签名到新文档**：攻击者从签名的遗留文档中提取出签名信息，包括签名文件（位于**`_xmlsignatures`**目录中）和任何相关的元数据。然后，攻击者将这些签名信息注入到新创建的OOXML文档中。这通常涉及修改新文档的内部文件结构，将签名信息复制到正确的位置，并确保新文档的格式和文件布局符合OOXML标准的要求。
    4. **修改新文档以引用遗留签名**：攻击者需要在新文档中添加或修改引用，使文档在打开时处理签名验证流程，从而识别和验证注入的遗留签名。这可能涉及修改文档的关系文件（如**`_rels/.rels`**），以确保签名文件（如**`sig1.xml`**）被识别为文档签名的一部分。
    5. **分发篡改的文档**：最后，攻击者将篡改后的文档分发给目标受害者。当受害者打开文档时，文档处理应用（如Microsoft Office）会识别并验证遗留签名，误以为文档是由可信实体签名的，从而向受害者展示攻击者控制的内容，同时显示签名为有效。

# 6 Implementation Attacks on OOXML Office Applications

## 6.1 通用签名伪造

1. 创建一个自签名OOXML文档 自签名用于让程序在package info中自动创建正确的引用与哈希值
2. 首先删除所有必要的XML签名元素 此步相当于创建一个XML包的骨架
3. 删除签名后 包信息不再受保护 例如document.xml 但是没有签名
4. 使用一个合法且由可信实体签名的文档（如odf）提取出签名信息并将odf内容添加到该文档

当受害者打开OOXML文档 package info 存储的摘要值与攻击者创建的内容相匹配 

## 恶意修复攻击

攻击者利用软件的自动修复功能，通过构造一个特殊的文档，使得当受害者打开并同意修复该文档时，实际展示给受害者的内容是攻击者控制的内容，而不是原始签名内容。这种攻击的关键在于，修复过程保留了文档的签名状态，误导用户认为文档内容是合法且未被篡改的。

### **实现步骤**

1. **获取合法签名的文档**：攻击者首先获取一个由可信实体合法签名的文档。这可以是攻击者自己创建的并请求签名，或是攻击者从其他渠道获得的已签名文档。
2. **准备攻击文档**：攻击者创建一个新的文档，其中包含攻击者希望最终展示给受害者的恶意内容。
3. **构造损坏的文档**：攻击者将原始签名的文档和准备的攻击文档以某种方式结合起来，形成一个看似损坏的文档。这通常涉及在文件包内添加额外的文件或修改文件结构，以触发文档处理软件的修复流程。
4. **分发篡改的文档**：攻击者将这个看似损坏的文档分发给目标受害者。
5. **触发修复流程**：当受害者打开该文档时，文档处理软件会检测到文档损坏，并提示用户进行修复。如果用户同意修复，软件会尝试恢复文档的可用状态。
6. **展示攻击者控制的内容**：在自动修复过程中，文档处理软件根据文件包内的结构尝试恢复文档，但由于攻击者的特殊构造，修复后展示给用户的实际上是攻击者准备的恶意内容。由于整个过程中原始文档的签名未被破坏，用户可能被误导认为修复后的内容是可信的。

# 7 Evaluation

### **测试环境设置**

研究者构建了一个包括多个虚拟机（VMs）的测试环境，这些虚拟机分别安装了不同版本的Microsoft Office和OnlyOffice Desktop。测试环境被分为三部分：签名Oracle环境、攻击者环境、受害者环境。签名Oracle环境用于模拟一个签名实体，可以为文档提供签名；攻击者环境用于创建和准备攻击向量；受害者环境用于打开和验证被篡改的文档，以观察文档和签名的表现。

### **评估结果**

评估结果揭示了以下关键发现：

1. **Microsoft Office（Windows）**：所有测试的Microsoft Office版本（包括2013、2016、2019、2021以及Office 365）都对上述攻击手法易受攻击。这表明攻击者可以在不破坏文档签名的情况下，修改文档内容，而这些修改对用户是不可见的。
2. **Microsoft Office（macOS）**：令人惊讶的是，macOS平台上的Microsoft Office版本没有正确实施签名验证。即使是完全删除或篡改签名文件，Office仍会显示文档被正确签名。这意味着在macOS上，攻击者可以更容易地篡改文档内容。
3. **OnlyOffice Desktop**：OnlyOffice Desktop在所有平台（Windows、macOS、Linux）上都表现出对某些攻击的易受攻击性，尤其是内容注入攻击（CIA）和恶意修复攻击（MRA）。但对于通用签名伪造攻击（USF），OnlyOffice表现出较好的抵抗力。

### **防御建议**

基于评估结果，研究者提出了一系列防御建议，包括：

- 对于文档处理软件开发者，需要增强对文档签名的验证机制，确保签名的完整性和不可篡改性。
- 对于用户，需要提高对数字签名和文档安全性的意识，谨慎处理来历不明的文档，尤其是那些提示需要修复的文档。
- 需要对OOXML等文档格式标准进行修订，以消除部分签名带来的安全风险。

# 8 Countermeasures

### **针对规范缺陷的防御措施**

- **消除部分签名支持**：OOXML标准中支持的部分签名是多数攻击能够成功的根本原因。建议修订OOXML等文档格式标准，取消对部分签名的支持，确保所有文档内容都被签名覆盖，从而增强文档的完整性和不可篡改性。
- **全面签名关系文件**：由于关系文件（如**`.rels`**文件）只是部分签名，攻击者可以在不触发签名验证失败的情况下添加新的文件引用。建议关系文件应被完全签名，以防止攻击者添加未签名的文件。
- **限制文件类型的内容**：OOXML文档中的某些文件（如**`styles.xml`**）可以用于注入渲染内容，即使这些内容未被签名。应严格限制文件类型所能包含的内容，防止通过这些文件注入未签名内容。

### **针对实现缺陷的防御措施**

- **增强签名验证过程**：文档处理软件（如Microsoft Office）应增强对文档签名的验证流程，确保不仅验证签名的有效性，还要验证签名确实覆盖了文档的全部内容。特别是，需要检查签名文件（如**`sig1.xml`**）是否正确引用了所有文档内容。
- **修复功能的安全性**：对于自动修复损坏文档的功能，软件应该在修复前验证文档签名的有效性。如果签名无效，应警告用户而不是自动修复文档。这可以防止攻击者利用修复功能来展示篡改后的内容。
