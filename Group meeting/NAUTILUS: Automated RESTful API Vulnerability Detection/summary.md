# 2 background

## 2.1 关键概念

### RESTful API

遵循REST标准的Web API称为RESTful API 遵循REST标准的Web服务称为RESTful服务

### OAS: OpenAPI Specification

OpenAPI定义了RESTful API标准

用户按照OAS生成有效的API操作 将其呈现为HTTP请求 以便与RESTful服务端点交互

## 2.2 Restful API 漏洞

RQ1：RESTful API漏洞的类别是什么

RQ2：触发RESTful API漏洞和触发Bug/内部服务器错误之间有什么区别

### 漏洞种类

重点在不当用户输入处理漏洞（XSS SQL注入 CSRF）

### 漏洞对比Bug检测 三方面差异

1. 攻击有效载荷
    
    Restful API 漏洞需要对应的有效负载来触发 注入到Restful请求的三个位置：主体参数、url内参数 cookie
    
2. API调用序列
    
    不同类型的漏洞需要不同的API请求序列
    
    SQL注入：一个GTE操作
    
    其他用户输入处理漏洞（XSS漏洞）：POST/PUT注入攻击负载+GET触发
    
3. 测试oracle
    
    漏洞与BUG需要不同的测试oracle捕获
    
    对于BUG只需要观察响应的状态码
    
    对于漏洞需要观察三样：
    
    应用攻击有效负载前后状态码变化
    
    应用攻击有效负载前后响应数据对象结构变化
    
    响应主体内容与攻击负载之间的语义关系
    

# 3 运行示例

解释为什么现有漏洞检测与渗透测试技术无法揭示

### CVE-2021-21389

渗透测试工具：只能测试SUT的一个API 而此示例需要六个API

BUG检测技术：1. 不能在请求中增加攻击载荷 2. 即使添加载荷也无法判定攻击是否成功

# 4 **NAUTILUS**设计

NAUTILUS 可以解析 OpenAPI 规范，理解 API 端点之间的关系，并利用新颖的注释原语来标记操作和参数，以生成逻辑操作序列。

能够探索潜在的易受攻击的 API 端点，并根据动态反馈自动更新注释。这意味着它能够实时地调整和优化漏洞检测策略，以更好地发现漏洞。

## chat

### 生成逻辑操作序列

1. **解析OpenAPI规范**：首先，NAUTILUS会解析OpenAPI规范，该规范描述了RESTful服务的API端点、操作和参数。
2. **理解API端点之间的关系**：通过分析OpenAPI规范，NAUTILUS可以理解API端点之间的关系，包括它们之间的调用顺序和依赖关系。
3. **标记操作和参数**：在理解了API端点之间的关系后，NAUTILUS使用新颖的注释原语来标记操作和参数。这些注释原语可能是通过从OpenAPI规范中提取信息或者通过其他方式生成的。
4. **生成逻辑操作序列**：利用标记的操作和参数，NAUTILUS可以生成逻辑操作序列，这些序列描述了在特定情况下执行的API操作顺序。这些逻辑序列是基于标记的操作和参数之间的关系和依赖生成的。

### 操作注释与参数注释

在NAUTILUS的设计和流程中，操作注释被用来构建API端点之间的关系图。NAUTILUS首先解析OpenAPI规范以理解API端点的结构和功能，然后使用操作注释来标记这些端点，并根据它们的关系生成逻辑操作序列。这些序列可以帮助NAUTILUS模拟攻击者的行为路径，从而发现潜在的漏洞。

在NAUTILUS的设计和流程中，参数注释被用来识别和标记API参数。NAUTILUS在解析API端点时会注意到参数注释，并根据这些注释对参数进行分类和分析。这些注释可以包含关于参数类型、格式、预期值范围等信息，有助于NAUTILUS更准确地识别潜在的漏洞，例如SQL注入、命令注入等。

## 4.1 概览

总体输入是SUT的OpenAPI规范 总体输出是更新后的OpenAPI规范

### 注释处理

1. 人类专家向OpenAPI规范添加初始注解
2. 范解析器将处理这些注解，提取API信息（API操作之间的关系和每个操作的参数详情）
    
    解析注释 理解API端点之间的关系 
    

### 两级测试

1. 利用提取到的API信息 **NAUTILUS**生成API操作序列测试SUT
**NAUTILUS**分两个阶段 每隔t时间切换
2. **Exploration阶段**：目的生成适当的API调用序列作为测试 请求尽可能多的API端点
3. 用SUT的反馈创建或更新注释 用于提取新的API信息
4. **Exploitation阶段**：将攻击载荷应用于上阶段成功的序列 以创建新的用例
5. 验证SUT的执行反馈来捕获漏洞

### 结果处理

1. 完成测试后 更新/注释 OpenAPI规范

## 4.2 规范注释

**目的是在OpenAPI规范中嵌入更多信息** 原本OpenAPI规范记得信息不全

### 4.2.1 操作注释

> 帮助构造有效的API序列
> 
- **Dep-operation 提前执行的依赖操作**
    
    ### 参数数据依赖
    
    一个操作中响应的变量被用作另一个操作的请求参数
    
    ### CRUD依赖
    
    根据 CRUD 关系强制执行 CRUD 限制并链接操作
    
    *使用参数数据依赖关系和 CRUD 依赖关系可能会产生相互矛盾的操作依赖关系*
    
    ### 逻辑依赖
    
    SUT内部逻辑引入的依赖关系
    
- **Term-operation**
    
    使用SUT注释终止当前会话的操作
    
- **Alias**
    
    注释整个操作中参数名的别名 
    
    维护不良的OAS在不同操作中有一个具有不同名称的参数
    

### 4.2.2 参数注释

目的：指导**NAUTILUS**生成和链接API操作的参数值 

现有策略：随机（根据规范随机值）与先前成功（最后一个成功请求的值生成一个参数值）

| **Example** | 为true使用OAS示例字段中记录的值 通常示例提供的参数值是正确的 |  |  |
| --- | --- | --- | --- |
| **Dynamic** | 为true将按照相同的顺序从先前成功请求的操作中获取相应的参数值
决定参数的机制来自于之前的操作 |  |  |
| **Success** | 为true使用上次成功请求的参数值 |  |  |
| **Mutation** | 突变程度 越高采用更灵活的变异参数值 |  |  |

最终参数生成策略是四个字段值的相互作用

### 4.2.3 注释更新

**注释初始化与手动更新**

**动态更新注释**

测试过程中 **NAUTILUS**根据SUT执行反馈动态更新注释 一下三种场景进行更新操作注释

1. OAS没有正确记录操作的响应体
2. 更新参数别名
3. 移除不可行的dep操作

### 4.2.4 注释原语

OpenAPI允许用户添加额外字段称为x参数 OpenAPI可以扩展到支持restful服务之外的表示

## 4.3 探索阶段

目标：通过正确构建的API操作序列 成功请求尽可能多的API操作

有趣：

可能受到精心设计的有效负载请求攻击的操作 

可以接受用户输入并添加/更新SUT后端数据的API操作

1. 如果是有趣的 **NAUTILUS**将检查该操作的深层操作 递归调用构建API调用序列 
2. 对于序列上的每个请求 根据参数注释按照生成策略生成参数 
3. 将请求发给SUT 验证是否成功

**NAUTILUS**探索策略关键点在于NAUTILUS知道最合适的参数值导致成功的请求 特别是NAUTILUS根据执行反馈识别最佳参数生成策略并记录在参数注释中

- chat
    
    探索阶段是 Nautilus 工具的核心部分，它利用启发式策略和动态分析技术来生成和探索 API 请求序列，并通过持续更新注释来优化漏洞检测过程。这种综合的方法使得 Nautilus 在发现和利用 RESTful API 漏洞方面具有很高的效率和准确性。
    

## 4.4 利用阶段

目的：检测尽可能多的漏洞

对于有趣的操作 NAUTILUS 将使用预定义的攻击有效负载来替换其参数

**工作流程：**

1. 收集有趣的API操作序列
2. 

### 4.4.1 Payload-based突变

1. NAUTILUS 识别可以注入的用户可控参数
2. 然后识别包含可注入参数的操作作为要测试的候选操作。从候选操作中选择一个操作，并从中选择一个参数作为突变目标。
3. 如果GET，将重用探索阶段生成的相应 API 操作序列。目标参数被有效负载值替换，以制定最终请求。其他参数值通常是根据带注释的策略生成的。
4. 如果POST/PUT，将随机选择一个与目标操作有 CRUD 关系的 GET 操作，并将其附加到 API 操作序列中。
    - 添加 GET 操作的基本原理是从 SUT 中获取更多信息作为测试预言

基于有效负载的变异。这种技术旨在生成变体有效负载，以测试目标系统对恶意输入的容忍度。具体来说，Nautilus 在生成有效负载时会引入各种变化，例如添加或修改参数、更改请求方法或路径等。通过对有效负载进行变异，Nautilus 可以有效地探索潜在的漏洞，同时尽量减少对目标系统造成的影响。

### 4.4. 2Payload and Oracle

**Oracle types** 

**Status Code** 一些漏洞可能导致SUT返回的状态代码的变化

**Data Structure** 一些漏洞可能导致操作返回与 OAS 中描述的数据结构不同的数据对象

**Semantic Relation** 一些漏洞可能会错误地执行有效负载内容并添加有效负载内容和响应内容之间的语义关系

结合有效负载生成和测试用例执行，以验证目标系统对特定输入的处理方式

根据有效负载生成请求，并向目标系统发送这些请求以触发潜在的漏洞

分析目标系统的响应，并根据预定义的测试用例来验证漏洞的存在

# 5 实现与评估

## 5.1 评估设置

### 评估基线

为了公平 选择可扩展的漏洞扫描器

1. Zed Attack Proxy
2. w3af
3. RESTLER
4. MOREST

### 评估基准

使用真实web应用程序 三个标准

1. 可再现的开源
2. 积极维护以验证安全发现
3. 完整的OAS或Restful文档

### 基准OpenAPI规范

使用相同的OASs测试评估基准

### 评估标准

漏洞：漏洞的数量是安全测试的管件标准

操作覆盖率

### 评估设置 结果收集

## 5.2 漏洞检测（RQ1）

## 5.3 覆盖率（RQ2）

## 5.4 消融研究（RQ3）

## 5.5 真实目的（RQ4）

---

# 相关知识

### 有效负载

有效负载（Payload）指的是在计算机安全领域中，用于利用漏洞或进行攻击的数据或指令序列。有效负载通常包含恶意代码、命令、数据或其他形式的输入，旨在利用系统的弱点或漏洞，以达到攻击者的目的。有效负载可以是各种形式，例如恶意软件、Shellcode、SQL 注入语句、跨站脚本（XSS）Payload 等。

有效负载在安全测试、漏洞利用和攻击中发挥着关键作用。攻击者利用有效负载来尝试入侵系统、获取未经授权的访问权限、执行恶意操作或窃取敏感信息。安全专家和研究人员则使用有效负载来评估系统的安全性，发现潜在的漏洞，并测试安全防御措施的有效性。通过设计和实施各种有效负载，安全专家可以模拟现实世界中的攻击场景，并评估系统对各种攻击的防御能力。
